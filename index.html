<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time XML/XSLT Transformation Tool</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Set darkMode to 'class' to enable manual toggling
        tailwind.config = {
            darkMode: 'class',
        }
    </script>

    <!-- Monaco Editor Loader -->
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.41.0/min/vs/loader.js"></script>

    <style>
        /* Custom styles for layout */
        body {
            font-family: 'Inter', sans-serif;
        }
        .flex-container {
            display: flex;
            flex-direction: column;
            height: 100%; 
        }
        .collapsible-section {
            transition: flex-grow 0.3s ease-in-out;
            display: flex; 
            flex-direction: column; 
            min-height: 48px; 
        }
        .collapsible-section .editor-wrapper {
             overflow: hidden;
        }
        .collapsed .editor-wrapper {
             display: none;
        }
        .collapsed {
            flex-grow: 0 !important;
        }
        .expanded {
            flex-grow: 1;
        }
        .chevron {
            transition: transform 0.3s ease-in-out;
        }
        .collapsed .chevron {
            transform: rotate(-90deg);
        }
        /* Custom toggle switch style */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #4f46e5;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #4f46e5;
        }
        /* Draggable Resizer Styles */
        #resizer {
            flex: 0 0 6px;
            cursor: col-resize;
            background-color: #e5e7eb; /* gray-200 */
            transition: background-color 0.2s ease;
        }
        .dark #resizer {
            background-color: #374151; /* gray-700 */
        }
        #resizer:hover,
        body.is-resizing #resizer {
            background-color: #4f46e5; /* indigo-600 */
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script>
        // Apply theme from localStorage immediately to prevent Flash of Unstyled Content (FOUC)
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 flex flex-col h-screen overflow-hidden">

    <!-- Header -->
    <header class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 p-3 shadow-md flex justify-between items-center">
        <h1 class="text-xl font-semibold text-gray-900 dark:text-white">XML/XSLT Transformation Tool</h1>
        <button id="theme-toggle" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500" aria-label="Toggle theme">
            <!-- Sun icon -->
            <svg id="theme-icon-light" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
            <!-- Moon icon -->
            <svg id="theme-icon-dark" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
        </button>
    </header>

    <!-- Main Content: Two-Pane Layout -->
    <main class="flex flex-1 flex-col md:flex-row overflow-hidden">
        
        <!-- Left Pane: Inputs -->
        <div id="left-pane" class="w-full flex flex-col p-2 overflow-hidden" style="flex: 1 1 50%;">
            <div class="flex-container bg-white dark:bg-gray-800 rounded-lg overflow-hidden border border-gray-200 dark:border-gray-700">
                <!-- XML Source Section -->
                <div id="xml-section" class="collapsible-section expanded border-b border-gray-200 dark:border-gray-700">
                    <div id="xml-header" class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700/50 cursor-pointer select-none border-b border-gray-200 dark:border-gray-700">
                        <h2 class="font-semibold">XML Source</h2>
                        <svg class="chevron w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div class="editor-wrapper flex-1">
                         <div id="xml-source-editor" class="w-full h-full"></div>
                    </div>
                </div>

                <!-- XSLT Stylesheet Section -->
                <div id="xslt-section" class="collapsible-section expanded">
                    <div id="xslt-header" class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700/50 cursor-pointer select-none border-b border-gray-200 dark:border-gray-700">
                        <h2 class="font-semibold">XSL Source</h2>
                        <svg class="chevron w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div class="editor-wrapper flex-1">
                        <div id="xslt-stylesheet-editor" class="w-full h-full"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Draggable Resizer -->
        <div id="resizer" class="hidden md:block"></div>

        <!-- Right Pane: Output -->
        <div id="right-pane" class="w-full flex flex-col p-2 overflow-hidden" style="flex: 1 1 50%;">
            <div class="flex flex-col h-full bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700">
                 <!-- Output Header -->
                 <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700/50 border-b border-gray-200 dark:border-gray-700">
                    <h2 class="font-semibold">Output</h2>
                    <div class="flex items-center space-x-3">
                        <span class="text-sm font-medium">Raw HTML</span>
                        <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" name="toggle" id="output-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" checked/>
                            <label for="output-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 dark:bg-gray-600 cursor-pointer"></label>
                        </div>
                        <span class="text-sm font-medium">Preview</span>
                    </div>
                </div>
                
                <!-- Output Content -->
                <div class="flex-1 relative overflow-hidden">
                    <!-- Error Display -->
                    <div id="error-display" class="hidden p-4 text-red-700 dark:text-red-400 bg-red-100 dark:bg-red-900/20 font-mono whitespace-pre-wrap"></div>
                    
                    <!-- Preview IFrame -->
                    <iframe id="output-preview" class="w-full h-full bg-white dark:bg-gray-900 border-0"></iframe>
                    
                    <!-- Raw HTML View -->
                    <div id="raw-html-container" class="hidden w-full h-full">
                        <div id="raw-html-editor" class="w-full h-full"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.41.0/min/vs' }});

        require(['vs/editor/editor.main'], function () {
            // --- DEFAULT CONTENT ---
            const defaultXML = `<?xml version="1.0" encoding="UTF-8"?>
<catalog>
  <book id="bk101">
    <author>Gambardella, Matthew</author>
    <title>XML Developer's Guide</title>
    <genre>Computer</genre>
    <price>44.95</price>
    <publish_date>2000-10-01</publish_date>
    <description>An in-depth look at creating applications with XML.</description>
  </book>
  <book id="bk102">
    <author>Ralls, Kim</author>
    <title>Midnight Rain</title>
    <genre>Fantasy</genre>
    <price>5.95</price>
    <publish_date>2000-12-16</publish_date>
    <description>A former architect battles corporate zombies, an evil sorceress, and her own inner demons.</description>
  </book>
  <book id="bk103">
    <author>Corets, Eva</author>
    <title>Maeve Ascendant</title>
    <genre>Fantasy</genre>
    <price>5.95</price>
    <publish_date>2000-11-17</publish_date>
    <description>After the collapse of a nanotechnology society in England, the young survivors lay the foundation for a new society.</description>
  </book>
</catalog>`;
            const defaultXSLT = `<?xml version="1.0" encoding="UTF-8"?>
<xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
<xsl:template match="/">
  <html>
    <head>
      <title>Book Catalog</title>
      <script src="https://cdn.tailwindcss.com"><\/script>
    </head>
    <body class="bg-gray-100 font-sans p-8">
      <h1 class="text-3xl font-bold mb-6 text-gray-800">Book Catalog</h1>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <xsl:for-each select="catalog/book">
        <div class="bg-white rounded-lg shadow-md p-6 border border-gray-200">
          <h2 class="text-xl font-semibold text-indigo-600 mb-2"><xsl:value-of select="title"/></h2>
          <p class="text-gray-600 mb-1">by <span class="font-medium text-gray-800"><xsl:value-of select="author"/></span></p>
          <p class="text-sm text-gray-500 mb-4">
            Genre: <span class="font-semibold"><xsl:value-of select="genre"/></span> | 
            Published: <span class="font-semibold"><xsl:value-of select="publish_date"/></span>
          </p>
          <p class="text-gray-700 mb-4"><xsl:value-of select="description"/></p>
          <div class="text-right text-2xl font-bold text-green-600">
            $<xsl:value-of select="price"/>
          </div>
        </div>
      </xsl:for-each>
      </div>
    </body>
  </html>
</xsl:template>
</xsl:stylesheet>`;

            // --- DOM ELEMENT REFERENCES ---
            const errorDisplay = document.getElementById('error-display');
            const outputPreview = document.getElementById('output-preview');
            const rawHtmlContainer = document.getElementById('raw-html-container');
            const outputToggle = document.getElementById('output-toggle');
            const themeToggle = document.getElementById('theme-toggle');
            const lightIcon = document.getElementById('theme-icon-light');
            const darkIcon = document.getElementById('theme-icon-dark');
            
            // --- THEME SWITCHER LOGIC ---
            let currentTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');

            function applyTheme(theme) {
                if (theme === 'dark') {
                    document.documentElement.classList.add('dark');
                    lightIcon.classList.add('hidden');
                    darkIcon.classList.remove('hidden');
                } else {
                    document.documentElement.classList.remove('dark');
                    lightIcon.classList.remove('hidden');
                    darkIcon.classList.add('hidden');
                }
                
                const editorTheme = theme === 'dark' ? 'vs-dark' : 'vs';
                monaco.editor.setTheme(editorTheme);

                localStorage.setItem('theme', theme);
                currentTheme = theme;
            }

            themeToggle.addEventListener('click', () => {
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                applyTheme(newTheme);
            });

            // --- MONACO EDITOR INITIALIZATION ---
            const editorOptions = {
                language: 'xml',
                wordWrap: 'on',
                automaticLayout: true,
                minimap: { enabled: false }
            };

            const xmlEditor = monaco.editor.create(document.getElementById('xml-source-editor'), {
                ...editorOptions,
                value: defaultXML,
            });
            const xsltEditor = monaco.editor.create(document.getElementById('xslt-stylesheet-editor'), {
                ...editorOptions,
                value: defaultXSLT,
            });
            const htmlEditor = monaco.editor.create(document.getElementById('raw-html-editor'), {
                ...editorOptions,
                language: 'html',
                value: '',
                readOnly: true,
            });

            // Apply the initial theme now that editors are created
            applyTheme(currentTheme);

            // --- DEBOUNCE FUNCTION ---
            function debounce(func, delay) {
                let timeout;
                return function(...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), delay);
                };
            }

            // --- CORE TRANSFORMATION LOGIC ---
            function performTransformation() {
                try {
                    errorDisplay.textContent = '';
                    errorDisplay.classList.add('hidden');

                    if(outputToggle.checked) {
                        outputPreview.classList.remove('hidden');
                        rawHtmlContainer.classList.add('hidden');
                    } else {
                        outputPreview.classList.add('hidden');
                        rawHtmlContainer.classList.remove('hidden');
                    }
                    const xmlString = xmlEditor.getValue();
                    const xsltString = xsltEditor.getValue();
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(xmlString, "application/xml");
                    const xsltDoc = parser.parseFromString(xsltString, "application/xml");
                    if (xmlDoc.getElementsByTagName("parsererror").length > 0) {
                        throw new Error("XML Parsing Error:\n" + xmlDoc.getElementsByTagName("parsererror")[0].innerText);
                    }
                     if (xsltDoc.getElementsByTagName("parsererror").length > 0) {
                        throw new Error("XSLT Parsing Error:\n" + xsltDoc.getElementsByTagName("parsererror")[0].innerText);
                    }
                    const processor = new XSLTProcessor();
                    processor.importStylesheet(xsltDoc);
                    const resultDocument = processor.transformToFragment(xmlDoc, document);
                    if (!resultDocument) {
                         throw new Error("Transformation failed. Check XSLT for errors.");
                    }
                    const serializer = new XMLSerializer();
                    const resultHtml = serializer.serializeToString(resultDocument);
                    htmlEditor.setValue(resultHtml);
                    const blob = new Blob([resultHtml], { type: 'text/html' });
                    if (outputPreview.dataset.blobUrl) {
                        URL.revokeObjectURL(outputPreview.dataset.blobUrl);
                    }
                    const url = URL.createObjectURL(blob);
                    outputPreview.src = url;
                    outputPreview.dataset.blobUrl = url;
                } catch (e) {
                    errorDisplay.textContent = e.message;
                    errorDisplay.classList.remove('hidden');
                    outputPreview.classList.add('hidden');
                    rawHtmlContainer.classList.add('hidden');
                }
            }
            
            // --- EVENT LISTENERS ---
            const debouncedTransform = debounce(performTransformation, 250);
            xmlEditor.onDidChangeModelContent(debouncedTransform);
            xsltEditor.onDidChangeModelContent(debouncedTransform);

            outputToggle.addEventListener('change', () => {
                 if (errorDisplay.classList.contains('hidden')) {
                    outputPreview.classList.toggle('hidden');
                    rawHtmlContainer.classList.toggle('hidden');
                }
            });

            function handleCollapse(sectionId) {
                const section = document.getElementById(`${sectionId}-section`);
                const otherSectionId = sectionId === 'xml' ? 'xslt' : 'xml';
                const otherSection = document.getElementById(`${otherSectionId}-section`);

                const isCollapsing = !section.classList.contains('collapsed');
                if (isCollapsing) {
                    section.classList.add('collapsed');
                    section.classList.remove('expanded');
                    if(otherSection.classList.contains('collapsed')) {
                        otherSection.classList.remove('collapsed');
                        otherSection.classList.add('expanded');
                    }
                } else {
                    section.classList.remove('collapsed');
                    section.classList.add('expanded');
                    if(!otherSection.classList.contains('collapsed')) {
                       otherSection.classList.add('collapsed');
                       otherSection.classList.remove('expanded');
                    }
                }
            }

            document.getElementById('xml-header').addEventListener('click', () => handleCollapse('xml'));
            document.getElementById('xslt-header').addEventListener('click', () => handleCollapse('xslt'));

            // --- RESIZER LOGIC ---
            const resizer = document.getElementById('resizer');
            const leftPane = document.getElementById('left-pane');
            const rightPane = document.getElementById('right-pane');

            resizer.addEventListener('mousedown', function (e) {
                e.preventDefault();
                document.body.classList.add('is-resizing');
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';

                const startX = e.clientX;
                const startWidth = leftPane.offsetWidth;

                const mouseMoveHandler = function (e) {
                    const newWidth = startWidth + (e.clientX - startX);
                    const mainWidth = leftPane.parentElement.offsetWidth;
                    
                    const minWidth = mainWidth * 0.15;
                    const maxWidth = mainWidth * 0.85;

                    if (newWidth > minWidth && newWidth < maxWidth) {
                        const newWidthPercent = (newWidth / mainWidth) * 100;
                        leftPane.style.flex = `0 0 ${newWidthPercent}%`;
                        rightPane.style.flex = `1 1 auto`;
                    }
                };

                const mouseUpHandler = function () {
                    document.documentElement.removeEventListener('mousemove', mouseMoveHandler);
                    document.documentElement.removeEventListener('mouseup', mouseUpHandler);
                    document.body.classList.remove('is-resizing');
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                };

                document.documentElement.addEventListener('mousemove', mouseMoveHandler);
                document.documentElement.addEventListener('mouseup', mouseUpHandler);
            });


            // --- INITIAL TRANSFORMATION ON LOAD ---
            performTransformation();
        });
    </script>
</body>
</html>

